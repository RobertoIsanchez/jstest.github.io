<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D Model Showcase - PBR Inspector</title>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      width: 100vw; height: 100vh; overflow: hidden;
      background: linear-gradient(180deg, #0a0a0a 0%, #2a2a2a 50%, #4a4a4a 100%);
    }
    #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
    .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }

    /* UI Panels */
    .top-bar {
      position: absolute; top: 30px; left: 0; width: 100%;
      display: flex; justify-content: space-between; align-items: flex-start;
      padding: 0 40px; pointer-events: none;
    }

    .logo-container { display: flex; align-items: center; gap: 12px; pointer-events: auto; }
    .logo-icon { width: 50px; height: 50px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; }
    .logo-text { color: #fff; }
    .logo-text h1 { font-size: 18px; font-weight: 700; letter-spacing: 2px; }
    .logo-text p { font-size: 10px; letter-spacing: 3px; opacity: 0.7; text-transform: uppercase; }

    /* Selector de Modos y Mapas */
    .controls-wrapper {
      display: flex; flex-direction: column; align-items: center; gap: 15px; pointer-events: auto;
    }

    .view-modes, .map-modes {
      display: flex; gap: 5px; background: rgba(0, 0, 0, 0.6);
      padding: 5px; border-radius: 30px; border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }

    .view-btn, .map-btn {
      padding: 6px 15px; border: none; background: transparent;
      color: #fff; font-size: 10px; letter-spacing: 1px;
      text-transform: uppercase; cursor: pointer; border-radius: 20px;
      transition: all 0.3s ease; opacity: 0.6;
    }

    .view-btn.active, .map-btn.active { background: #fff; color: #000; opacity: 1; }
    .view-btn:hover:not(.active), .map-btn:hover:not(.active) { opacity: 1; background: rgba(255, 255, 255, 0.1); }

    .map-modes { margin-top: 5px; display: none; } /* Se muestra solo en modo 'Maps' */

    /* Info T√©cnica */
    .tech-info { position: absolute; bottom: 40px; left: 40px; color: #fff; max-width: 350px; pointer-events: auto; }
    .model-number { font-size: 48px; font-weight: 800; margin-bottom: 5px; background: linear-gradient(90deg, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .model-name { font-size: 14px; letter-spacing: 2px; text-transform: uppercase; opacity: 0.8; margin-bottom: 20px; }
    .tech-specs { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
    .spec-row { display: flex; gap: 20px; font-size: 11px; opacity: 0.6; }
    .spec-label { min-width: 80px; text-transform: uppercase; }
    .spec-value { color: #aaa; }

    /* Animaciones */
    .animation-controls { display: flex; gap: 10px; align-items: center; }
    .anim-btn { width: 36px; height: 36px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; }
    .anim-btn svg { width: 16px; height: 16px; fill: #fff; }
    .anim-select { padding: 8px 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 4px; color: #fff; font-size: 11px; cursor: pointer; min-width: 120px; }

    /* Lighting */
    .lighting-controls { position: absolute; right: 40px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 12px; pointer-events: auto; }
    .light-btn { width: 44px; height: 44px; border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.3); cursor: pointer; transition: all 0.3s ease; position: relative; }
    .light-btn.active { border-color: #fff; box-shadow: 0 0 15px rgba(255, 255, 255, 0.4); }
    .light-btn::after { content: attr(data-name); position: absolute; right: 55px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 5px 10px; border-radius: 4px; font-size: 10px; opacity: 0; pointer-events: none; transition: 0.3s; white-space: nowrap; }
    .light-btn:hover::after { opacity: 1; }

    .light-btn[data-hdr="studio"] { background: #333; }
    .light-btn[data-hdr="sunset"] { background: #ff7e5f; }
    .light-btn[data-hdr="night"] { background: #0f0c29; }

    /* Loading */
    .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; text-align: center; }
    .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .background-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 15vw; font-weight: 900; color: rgba(255,255,255,0.02); z-index: 0; pointer-events: none; white-space: nowrap; }
  </style>
</head>
<body>
  <div id="canvas-container"></div>
  <div class="background-text">INSPECTOR</div>

  <div class="overlay">
    <div class="top-bar">
      <div class="logo-container">
        <div class="logo-icon">üîç</div>
        <div class="logo-text">
          <h1>PBR VIEWER</h1>
          <p>Technical Inspection</p>
        </div>
      </div>

      <div class="controls-wrapper">
        <div class="view-modes">
          <button class="view-btn active" data-mode="full">Render</button>
          <button class="view-btn" data-mode="maps">Mapas PBR</button>
          <button class="view-btn" data-mode="wireframe">Wireframe</button>
        </div>
        <div class="map-modes" id="map-selector">
          <button class="map-btn active" data-map="albedo">Albedo</button>
          <button class="map-btn" data-map="roughness">Roughness</button>
          <button class="map-btn" data-map="metallic">Metallic</button>
          <button class="map-btn" data-map="normal">Normal</button>
          <button class="map-btn" data-map="emissive">Emissive</button>
        </div>
      </div>

      <div style="width: 150px;"></div> <!-- Spacer -->
    </div>

    <div class="tech-info">
      <div class="model-number">01</div>
      <div class="model-name">Owl Character</div>
      <div class="tech-specs">
        <div class="spec-row"><span class="spec-label">Pol√≠gonos</span><span class="spec-value" id="poly-count">...</span></div>
        <div class="spec-row"><span class="spec-label">Modo Actual</span><span class="spec-value" id="current-mode-text">Render Completo</span></div>
      </div>
      <div class="animation-controls" id="animation-controls"></div>
    </div>

    <div class="lighting-controls">
      <div class="light-btn active" data-hdr="studio" data-name="Studio"></div>
      <div class="light-btn" data-hdr="sunset" data-name="Sunset"></div>
      <div class="light-btn" data-hdr="night" data-name="Night"></div>
    </div>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div id="load-text">Cargando...</div>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    // Scene Setup
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(3, 2, 5);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.2;
    document.getElementById('canvas-container').appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // Lights
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);
    const mainLight = new THREE.DirectionalLight(0xffffff, 1.5);
    mainLight.position.set(5, 10, 7);
    scene.add(mainLight);

    // State
    let loadedModel = null;
    let mixer = null;
    const clock = new THREE.Clock();
    const materialsData = new Map(); // Store original and debug materials

    // Materials Logic
    function createDebugMaterials(child) {
      const original = child.material;
      const debug = {};

      // Albedo (Color base)
      debug.albedo = new THREE.MeshBasicMaterial({ 
        map: original.map, 
        color: original.color,
        skinning: original.skinning, morphTargets: original.morphTargets 
      });

      // Roughness (Escala de grises)
      debug.roughness = new THREE.MeshBasicMaterial({ 
        map: original.roughnessMap || null,
        color: original.roughnessMap ? 0xffffff : new THREE.Color(original.roughness, original.roughness, original.roughness),
        skinning: original.skinning, morphTargets: original.morphTargets
      });

      // Metallic (Escala de grises)
      debug.metallic = new THREE.MeshBasicMaterial({ 
        map: original.metalnessMap || null,
        color: original.metalnessMap ? 0xffffff : new THREE.Color(original.metalness, original.metalness, original.metalness),
        skinning: original.skinning, morphTargets: original.morphTargets
      });

      // Normal (Mapa de normales)
      debug.normal = new THREE.MeshBasicMaterial({ 
        map: original.normalMap || null,
        color: original.normalMap ? 0xffffff : 0x8080ff, // Color neutro de normal si no hay mapa
        skinning: original.skinning, morphTargets: original.morphTargets
      });

      // Emissive
      debug.emissive = new THREE.MeshBasicMaterial({ 
        map: original.emissiveMap || null,
        color: original.emissive,
        skinning: original.skinning, morphTargets: original.morphTargets
      });

      // Wireframe
      debug.wireframe = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true });

      materialsData.set(child, { original, debug });
    }

    function updateVisualMode(mode, mapType = 'albedo') {
      if (!loadedModel) return;
      
      const modeText = document.getElementById('current-mode-text');
      const mapSelector = document.getElementById('map-selector');
      
      mapSelector.style.display = mode === 'maps' ? 'flex' : 'none';

      loadedModel.traverse(child => {
        if (child.isMesh) {
          const data = materialsData.get(child);
          if (!data) return;

          if (mode === 'full') {
            child.material = data.original;
            modeText.textContent = "Render Completo";
          } else if (mode === 'wireframe') {
            child.material = data.debug.wireframe;
            modeText.textContent = "Wireframe";
          } else if (mode === 'maps') {
            child.material = data.debug[mapType];
            modeText.textContent = `Mapa: ${mapType.toUpperCase()}`;
          }
        }
      });
    }

    // UI Events
    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        updateVisualMode(btn.dataset.mode);
      };
    });

    document.querySelectorAll('.map-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.map-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        updateVisualMode('maps', btn.dataset.map);
      };
    });

    // Model Loading
    const loader = new GLTFLoader();
    loader.load('ixo.glb', (gltf) => {
      loadedModel = gltf.scene;
      
      // Setup materials
      let triangles = 0;
      loadedModel.traverse(child => {
        if (child.isMesh) {
          triangles += child.geometry.attributes.position.count / 3;
          createDebugMaterials(child);
        }
      });
      document.getElementById('poly-count').textContent = `${Math.round(triangles).toLocaleString()} Tris`;

      // Center & Scale
      const box = new THREE.Box3().setFromObject(loadedModel);
      const size = box.getSize(new THREE.Vector3());
      const center = box.getCenter(new THREE.Vector3());
      const scale = 2.5 / Math.max(size.x, size.y, size.z);
      loadedModel.scale.setScalar(scale);
      loadedModel.position.set(-center.x*scale, -center.y*scale + 0.5, -center.z*scale);

      scene.add(loadedModel);
      document.getElementById('loading').style.display = 'none';

      if (gltf.animations.length > 0) {
        mixer = new THREE.AnimationMixer(loadedModel);
        const action = mixer.clipAction(gltf.animations[0]);
        action.play();
        
        // Simple animation UI
        const animUI = document.getElementById('animation-controls');
        animUI.innerHTML = `<button class="anim-btn" id="play-pause">‚è∏</button>
                            <select class="anim-select" id="anim-sel"></select>`;
        
        const sel = document.getElementById('anim-sel');
        gltf.animations.forEach((a, i) => {
          const opt = document.createElement('option');
          opt.value = i; opt.textContent = a.name || `Anim ${i+1}`;
          sel.appendChild(opt);
        });

        document.getElementById('play-pause').onclick = (e) => {
          const paused = action.paused;
          action.paused = !paused;
          e.target.textContent = paused ? '‚è∏' : '‚ñ∂';
        };
      }
    }, (p) => {
      document.getElementById('load-text').textContent = `Cargando... ${(p.loaded/p.total*100).toFixed(0)}%`;
    });

    // Render Loop
    function animate() {
      requestAnimationFrame(animate);
      if (mixer) mixer.update(clock.getDelta());
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    window.onresize = () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    };
  </script>
</body>
</html>
